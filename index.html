<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <!-- Rangem mobiili viewport, et Messenger ei zoomiks ega skaleeriks teksti -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>EVKI harjutustest</title>
  <style>
    /* Globaalne normaliseerimine: ära skaleeri teksti automaatselt */
    html, body {
      -webkit-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
      line-height: 1.5;
      font-size: 16px; /* base 16px, aitab vältida iOS autofookuse zoomi */
    }
    h1 { margin-top: 0; }
    .question { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; }
    .question p { margin: 0 0 8px 0; font-weight: bold; }

    /* Ühtlane fondisuurus vastuste jaoks + keelame skaleerimise kindlalt labelitel */
    label {
      display: inline-block;
      margin: 4px 0;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 16px !important;          /* ühtlane suurus */
      line-height: 1.4;                     /* stabiilne ridade kõrgus */
      -webkit-text-size-adjust: none !important; /* keelame iOS WebView skaleerimise labelitel */
      text-size-adjust: none !important;         /* keelame teistes WebView'des */
      word-break: break-word;               /* kui on pikad variandid */
    }

    button { padding: 10px 20px; font-size: 16px; margin-right: 8px; cursor: pointer; }
    .correct  { background-color: #c8f7c5; } /* heleroheline */
    .incorrect{ background-color: #f7c5c5; } /* helepunane */
    #result { font-weight: bold; margin-top: 12px; }
    #error  { color: #b00020; margin-top: 12px; }

    /* TAIMER & PROTSENT: stiilid */
    #timer { margin-top: 8px; color: #333; }
    #extra { margin-top: 6px; color: #333; }
  </style>
</head>
<body>

  <h1>EVKI harjutustest</h1>
  <p>Siin on 20 juhuslikku küsimust 85st. Vali vastused ja vajuta „Näita tulemust”, uue testi jaoks vajuta „Tee uus test”. Rahu ja edu!</p>

  <div id="quiz"></div>

  <button id="checkBtn">Näita tulemust</button>
  <button id="newBtn">Tee uus test</button>

  <p id="result"></p>
  <!-- TAIMER & PROTSENT: jooksev taimer + lisainfo -->
  <p id="timer" aria-live="polite"></p>
  <p id="extra"></p>

  <p id="error"></p>

  <!-- INLINE skript -->
  <script>
    console.log('EVKI app: inline script käivitub');

    let allQuestions = [];
    let quizQuestions = [];

    // TAIMER & PROTSENT: ajamõõtmise muutujad
    let quizStartTs = null;
    let timerInterval = null;

    // Initsialiseeri kui DOM on valmis
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('EVKI app: DOMContentLoaded');
      document.getElementById('checkBtn').addEventListener('click', submitQuiz);
      document.getElementById('newBtn').addEventListener('click', newTest);

      await loadQuestions();
      startQuiz();
    });

    async function loadQuestions() {
      const errEl = document.getElementById('error');
      errEl.textContent = '';
      try {
        const res = await fetch('./questions.json?v=' + Date.now());
        console.log('EVKI app: fetch questions.json status', res.status);
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const text = await res.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('Tyhi või vale formaadis JSON');
        }
        allQuestions = data;
        console.log('EVKI app: questions.json laaditud, kirjeid:', data.length);
      } catch (e) {
        console.warn('EVKI app: JSON load/parse error:', e);
        errEl.textContent = 'Hoiatus: questions.json ei laadinud. Kasutan näidisküsimusi. (See on OK testimiseks.)';
        allQuestions = [
          {
            question: 'Mis on ettevõtluskeskkond?',
            options: [
              'Ainult ettevõtte sisekeskkond',
              'Ettevõtet ümbritsev sise- ja välistegurite kogum',
              'Ainult makrokeskkond',
              'Ainult seadusandlus'
            ],
            correct: 1
          },
          {
            question: 'Mis on PESTLE analüüs?',
            options: [
              'Finantsanalüüs',
              'Turundusanalüüs',
              'Makrokeskkonna analüüs',
              'Konkurentsianalüüs'
            ],
            correct: 2
          },
          {
            question: 'Millisteks keskkondadeks jaguneb ettevõtluskeskkond?',
            options: [
              'Sisekeskkond ja väliskeskkond',
              'Avalik ja erasektor',
              'Kohalik ja globaalne',
              'Tööstus ja teenused'
            ],
            correct: 0
          }
        ];
        console.log('EVKI app: fallback-küsimused kasutusel');
      }
    }

    function startQuiz() {
      quizQuestions = shuffleArray(allQuestions).slice(0, 20);
      renderQuiz();
      const resultEl = document.getElementById('result');
      if (resultEl) resultEl.textContent = '';

      // TAIMER & PROTSENT: käivita stopper
      startTimer();

      // Tühjenda lisainfo plokid
      setText('extra', '');
      console.log('EVKI app: startQuiz OK, kuvatakse', quizQuestions.length, 'küsimust');
    }

    // Vastusevariantide juhuslik järjestus
    function shuffleOptionsWithCorrectFlag(q) {
      const pairs = q.options.map((opt, idx) => ({
        text: opt,
        isCorrect: idx === q.correct
      }));
      const shuffled = shuffleArray(pairs);
      const correctShuffled = shuffled.findIndex(p => p.isCorrect);
      return { shuffled, correctShuffled };
    }

    function renderQuiz() {
      const quizDiv = document.getElementById('quiz');
      quizDiv.innerHTML = '';

      quizQuestions.forEach((q, index) => {
        const { shuffled, correctShuffled } = shuffleOptionsWithCorrectFlag(q);
        q._shuffledOptions = shuffled;
        q._correctShuffled = correctShuffled;

        let html = '<div class="question">';
        html += '<p><strong>' + (index + 1) + '. ' + escapeHtml(q.question) + '</strong></p>';
        shuffled.forEach((pair, i) => {
          html += `
            <label>
              <input type="radio" name="q${index}" value="${i}">
              ${escapeHtml(pair.text)}
            </label><br>`;
        });
        html += '</div>';
        quizDiv.innerHTML += html;
      });
    }

    function submitQuiz() {
      let score = 0;

      quizQuestions.forEach((q, index) => {
        const selected = document.querySelector('input[name="q' + index + '"]:checked');
        const optionInputs = document.querySelectorAll('input[name="q' + index + '"]');

        optionInputs.forEach(inp => { inp.disabled = true; });

        const correctIndex = (typeof q._correctShuffled === 'number')
          ? q._correctShuffled
          : q.correct;

        const correctInput = document.querySelector('input[name="q' + index + '"][value="' + correctIndex + '"]');
        if (correctInput) {
          const correctLabel = correctInput.closest('label');
          if (correctLabel) correctLabel.classList.add('correct');
        }

        if (selected) {
          const selectedIndex = Number(selected.value);
          if (selectedIndex === correctIndex) {
            score++;
          } else {
            const wrongLabel = selected.closest('label');
            if (wrongLabel) wrongLabel.classList.add('incorrect');
          }
        }
      });

      // TAIMER & PROTSENT: peata stopper ja kuva aeg + protsent
      const elapsedMs = stopTimer(); // ms
      const percent = quizQuestions.length > 0
        ? Math.round((score / quizQuestions.length) * 100)
        : 0;

      document.getElementById('result').innerText =
        'Tulemus: ' + score + ' / ' + quizQuestions.length + ' (' + percent + '%)';

      setText('extra', 'Aeg: ' + formatDuration(elapsedMs));
    }

    function newTest() {
      startQuiz();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // === TAIMER & PROTSENT: utiliidid ===
    function startTimer() {
      quizStartTs = Date.now();
      // puhasta varasemad intervallid
      if (timerInterval) clearInterval(timerInterval);
      // uuenda kord sekundis jooksvat taimerit
      timerInterval = setInterval(() => {
        const ms = Date.now() - quizStartTs;
        setText('timer', 'Aeg: ' + formatDuration(ms));
      }, 1000);
      // kohe esimene väärtus ka
      setText('timer', 'Aeg: ' + formatDuration(0));
    }

    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      const elapsed = quizStartTs ? (Date.now() - quizStartTs) : 0;
      return elapsed;
    }

    function formatDuration(ms) {
      const totalSeconds = Math.floor(ms / 1000);
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      const seconds = totalSeconds % 60;
      const hh = hours > 0 ? String(hours).padStart(2, '0') + ':' : '';
      const mm = String(minutes).padStart(2, '0');
      const ss = String(seconds).padStart(2, '0');
      return hh + mm + ':' + ss; // näiteks 05:32 või 01:05:32
    }

    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    window.submitQuiz = submitQuiz;
    window.newTest = newTest;
  </script>
</body>
</html>
