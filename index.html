<!DOCTYPE html>
<html lang="et">
<head>
  <meta charset="UTF-8" />
  <!-- Rangem mobiili viewport, et Messenger ei zoomiks ega skaleeriks teksti -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>EVKI harjutustest</title>
  <style>
    /* ====== Teemavärvid (CSS muutujad) ====== */
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --border: #cccccc;
      --correct: #c8f7c5;
      --incorrect: #f7c5c5;
      --btn-bg: #f0f0f0;
      --btn-fg: #111111;
    }
    /* Kui süsteem on tumeda eelistusega, kasuta tumeda teema väärtusi */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #121212;
        --fg: #eaeaea;
        --border: #2a2a2a;
        --correct: #1f6f43;   /* tumedale sobiv heleroheline toon */
        --incorrect: #7a2f2f; /* tumedale sobiv helepunane toon */
        --btn-bg: #1e1e1e;
        --btn-fg: #eaeaea;
      }
    }
    /* Kui kehal on .dark, sunnime tumeda teema (vaikimisi üle) */
    body.dark {
      --bg: #121212;
      --fg: #eaeaea;
      --border: #2a2a2a;
      --correct: #1f6f43;
      --incorrect: #7a2f2f;
      --btn-bg: #1e1e1e;
      --btn-fg: #eaeaea;
    }

    /* Globaalne normaliseerimine: ära skaleeri teksti automaatselt (Messenger WebView) */
    html, body {
      -webkit-text-size-adjust: 100% !important;
      text-size-adjust: 100% !important;
    }

    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 24px;
      line-height: 1.5;
      font-size: 16px; /* base 16px, aitab vältida iOS autofookuse zoomi */
      background: var(--bg);
      color: var(--fg);
    }
    h1 { margin-top: 0; }

    /* Ülaala: dark mode lüliti */
    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .topbar .controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .question { margin-bottom: 20px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; }
    .question p { margin: 0 0 8px 0; font-weight: bold; }

    /* Ühtlane fondisuurus vastuste jaoks + keelame skaleerimise kindlalt labelitel */
    label {
      display: inline-block;
      margin: 4px 0;
      padding: 2px 4px;
      border-radius: 4px;
      font-size: 16px !important;          /* ühtlane suurus */
      line-height: 1.4;                     /* stabiilne ridade kõrgus */
      -webkit-text-size-adjust: none !important; /* keelame iOS WebView skaleerimise labelitel */
      text-size-adjust: none !important;         /* keelame teistes WebView'des */
      word-break: break-word;               /* kui on pikad variandid */
    }

    button {
      padding: 10px 16px;
      font-size: 16px;
      margin-right: 8px;
      cursor: pointer;
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: 1px solid var(--border);
      border-radius: 6px;
    }
    button:focus-visible { outline: 2px solid #4b8bf4; outline-offset: 2px; }

    .correct  { background-color: var(--correct); }
    .incorrect{ background-color: var(--incorrect); }
    #result { font-weight: bold; margin-top: 12px; }
    #error  { color: #b00020; margin-top: 12px; }

    /* Dark mode lüliti stiil */
    #themeToggle {
      background: var(--btn-bg);
      color: var(--btn-fg);
      border: 1px solid var(--border);
    }
  </style>
</head>
<body>
  <div class="topbar">
    <h1>EVKI harjutustest</h1>
    <div class="controls">
      <!-- Dark mode lüliti -->
      <button id="themeToggle" title="Vaheta teemat (hele/tume)">Dark mode</button>
    </div>
  </div>

  <p>Siin on 20 juhuslikku küsimust 85st. Vali vastused ja vajuta „Näita tulemust”, uue testi jaoks vajuta „Tee uus test”. Rahu ja edu!</p>

  <div id="quiz"></div>

  <button id="checkBtn">Näita tulemust</button>
  <button id="newBtn">Tee uus test</button>

  <p id="result"></p>
  <p id="error"></p>

  <!-- INLINE skript -->
  <script>
    console.log('EVKI app: inline script käivitub');

    let allQuestions = [];
    let quizQuestions = [];

    // Initsialiseeri kui DOM on valmis
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('EVKI app: DOMContentLoaded');

      // Teema eelistuse taastamine
      initTheme();

      // Nupud
      document.getElementById('checkBtn').addEventListener('click', submitQuiz);
      document.getElementById('newBtn').addEventListener('click', newTest);
      document.getElementById('themeToggle').addEventListener('click', toggleTheme);

      await loadQuestions();
      startQuiz();
    });

    // ====== Dark mode lüliti loogika ======
    function initTheme() {
      try {
        const saved = localStorage.getItem('evki-theme'); // 'dark' | 'light' | null
        if (saved === 'dark') {
          document.body.classList.add('dark');
        } else if (saved === 'light') {
          document.body.classList.remove('dark');
        } else {
          // Kui salvestatud valikut pole, las süsteem otsustab (prefers-color-scheme).
          // Siin ei muuda midagi: CSS @media määrab vaikimisi värvid.
        }
        updateThemeToggleLabel();
      } catch (e) {
        console.warn('EVKI app: teema eelistuse lugemine ebaõnnestus', e);
      }
    }

    function toggleTheme() {
      const isDark = document.body.classList.toggle('dark');
      try {
        localStorage.setItem('evki-theme', isDark ? 'dark' : 'light');
      } catch (e) {
        console.warn('EVKI app: teema eelistuse salvestamine ebaõnnestus', e);
      }
      updateThemeToggleLabel();
    }

    function updateThemeToggleLabel() {
      const btn = document.getElementById('themeToggle');
      if (!btn) return;
      const isDark = document.body.classList.contains('dark');
      btn.textContent = isDark ? 'Light mode' : 'Dark mode';
      btn.title = isDark ? 'Vaheta hele teema' : 'Vaheta tume teema';
    }

    // ====== Küsimused & test ======
    async function loadQuestions() {
      const errEl = document.getElementById('error');
      errEl.textContent = '';
      try {
        const res = await fetch('./questions.json?v=' + Date.now()); // cache-busting
        console.log('EVKI app: fetch questions.json status', res.status);
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const text = await res.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data) || data.length === 0) {
          throw new Error('Tyhi või vale formaadis JSON');
        }
        allQuestions = data;
        console.log('EVKI app: questions.json laaditud, kirjeid:', data.length);
      } catch (e) {
        console.warn('EVKI app: JSON load/parse error:', e);
        errEl.textContent = 'Hoiatus: questions.json ei laadinud. Kasutan näidisküsimusi. (See on OK testimiseks.)';
        // Fallback – et leht kindlasti toimiks (3 näidisküsimust)
        allQuestions = [
          {
            question: 'Mis on ettevõtluskeskkond?',
            options: [
              'Ainult ettevõtte sisekeskkond',
              'Ettevõtet ümbritsev sise- ja välistegurite kogum',
              'Ainult makrokeskkond',
              'Ainult seadusandlus'
            ],
            correct: 1
          },
          {
            question: 'Mis on PESTLE analüüs?',
            options: [
              'Finantsanalüüs',
              'Turundusanalüüs',
              'Makrokeskkonna analüüs',
              'Konkurentsianalüüs'
            ],
            correct: 2
          },
          {
            question: 'Millisteks keskkondadeks jaguneb ettevõtluskeskkond?',
            options: [
              'Sisekeskkond ja väliskeskkond',
              'Avalik ja erasektor',
              'Kohalik ja globaalne',
              'Tööstus ja teenused'
            ],
            correct: 0
          }
        ];
        console.log('EVKI app: fallback-küsimused kasutusel');
      }
    }

    function startQuiz() {
      quizQuestions = shuffleArray(allQuestions).slice(0, 20);
      renderQuiz();
      const resultEl = document.getElementById('result');
      if (resultEl) resultEl.textContent = '';
      console.log('EVKI app: startQuiz OK, kuvatakse', quizQuestions.length, 'küsimust');
    }

    // Vastusevariantide juhuslik järjestus
    function shuffleOptionsWithCorrectFlag(q) {
      const pairs = q.options.map((opt, idx) => ({
        text: opt,
        isCorrect: idx === q.correct
      }));
      const shuffled = shuffleArray(pairs);
      const correctShuffled = shuffled.findIndex(p => p.isCorrect);
      return { shuffled, correctShuffled };
    }

    function renderQuiz() {
      const quizDiv = document.getElementById('quiz');
      quizDiv.innerHTML = '';

      quizQuestions.forEach((q, index) => {
        const { shuffled, correctShuffled } = shuffleOptionsWithCorrectFlag(q);
        q._shuffledOptions = shuffled;
        q._correctShuffled = correctShuffled;

        let html = '<div class="question">';
        html += '<p><strong>' + (index + 1) + '. ' + escapeHtml(q.question) + '</strong></p>';
        shuffled.forEach((pair, i) => {
          html += `
            <label>
              <input type="radio" name="q${index}" value="${i}">
              ${escapeHtml(pair.text)}
            </label><br>`;
        });
        html += '</div>';
        quizDiv.innerHTML += html;
      });
    }

    function submitQuiz() {
      let score = 0;

      quizQuestions.forEach((q, index) => {
        const selected = document.querySelector('input[name="q' + index + '"]:checked');
        const optionInputs = document.querySelectorAll('input[name="q' + index + '"]');

        optionInputs.forEach(inp => { inp.disabled = true; });

        const correctIndex = (typeof q._correctShuffled === 'number')
          ? q._correctShuffled
          : q.correct;

        const correctInput = document.querySelector('input[name="q' + index + '"][value="' + correctIndex + '"]');
        if (correctInput) {
          const correctLabel = correctInput.closest('label');
          if (correctLabel) correctLabel.classList.add('correct');
        }

        if (selected) {
          const selectedIndex = Number(selected.value);
          if (selectedIndex === correctIndex) {
            score++;
          } else {
            const wrongLabel = selected.closest('label');
            if (wrongLabel) wrongLabel.classList.add('incorrect');
          }
        }
      });

      // Kuvame tulemuse koos protsendiga
      const percent = quizQuestions.length > 0
        ? Math.round((score / quizQuestions.length) * 100)
        : 0;

      document.getElementById('result').innerText =
        'Tulemus: ' + score + ' / ' + quizQuestions.length + ' (' + percent + '%)';
    }

    function newTest() {
      startQuiz();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function shuffleArray(arr) {
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    window.submitQuiz = submitQuiz;
    window.newTest = newTest;
  </script>
</body>
</html>
